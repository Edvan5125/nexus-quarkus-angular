
<div class="caixa-chat">

  <!-- barra lateral com botoes -->

  <aside class="barra-lateral">

    <div class="menu">
      <button class="botao-editar">‚úé</button>
      <button class="botao-config" (click)="abrirConfiguracao()" aria-label="Configura√ß√£o">‚öô</button>

      <!-- pontos: icone com badge abre painel lateral de pontos -->
      <button class="botao-pontos" (click)="togglePainelPontos()" aria-label="Pontos e recompensas">
        üèÜ
        @if (notificacaoPontos > 0) { <span class="badge-pontos">{{ notificacaoPontos }}</span> }
      </button>

      <!-- conquistas: √≠cone com badge abre painel lateral de conquistas -->
      <button class="botao-conquistas" (click)="togglePainelConquistas()" aria-label="Conquistas e realiza√ß√µes">
        üèÖ
        @if (notificacaoConquistas > 0) { <span class="badge-conquistas">{{ notificacaoConquistas }}</span> }
      </button>

    </div>

    @if (showPontos) {
      <div class="bloco-pontos" role="dialog" aria-label="Pontos e hist√≥rico">
        <div class="cabecalho-pontos">
          <span class="titulo">Pontos</span>
          <button class="fechar" (click)="togglePainelPontos()">‚úñ</button>
        </div>
        <div class="resumo-pontos">

          <div class="linha"><span>Total:</span><strong>{{ pontos }}</strong></div>
          <div class="linha"><span>N√≠vel:</span><strong>{{ nivel }}</strong></div>
          <div class="xp-area">

            <div class="xp-barra"><div class="xp-preenchimento" [style.width.%]="progressoNivel"></div></div>
            <span class="xp-texto">{{ progressoNivel }}/100</span>
          </div>
        </div>

        <div class="historico">

          <div class="hist-titulo">Hist√≥rico</div>
          <ul>
            <li *ngFor="let h of historicoPontos; let i = index; trackBy: trackByIndex">
              <span class="quando">{{h.quando}}</span>
              <span class="motivo">+{{h.qtd}} ‚Äî {{h.motivo}}</span>
            </li>
          </ul>
        </div>
        <div class="acoes">
          <button (click)="marcarPontosComoLidos()">Marcar como lido</button>
        </div>
      </div>
    }

    @if (showConquistas) {

      <div class="bloco-conquistas" role="dialog" aria-label="Conquistas e realiza√ß√µes">
        <div class="cabecalho-conq">

          <span class="titulo">Conquistas</span>

          <button class="fechar" (click)="togglePainelConquistas()">‚úñ</button>

        </div>

        <div class="lista-conquistas">

          <ul>
            <li *ngFor="let c of conquistas; let i = index; trackBy: trackByIndex" 
            [class.desbloqueada]="c.desbloqueada">
              <span class="status">{{c.desbloqueada ? '‚úÖ' : 'üîí'}}</span>

              <div class="info">

                <div class="titulo">{{c.titulo}}</div>

                <div class="desc">{{ c.descricao }}</div>
                
                @if (c.desbloqueada && c.quando) { <div class="quando">{{c.quando}}</div> }
              </div>
            </li>

          </ul>

        </div>
        @if (historicoConquistas.length) {

          <div class="historico-conq">
            <div class="hist-titulo">Recentes</div>
            <ul>
              <li *ngFor="let h of historicoConquistas; let i = index; trackBy: trackByIndex">
                <span class="quando">{{ h.quando }}</span>
                <span class="mensagem">{{ h.mensagem }}</span>
              </li>
            </ul>
          </div>

        }
        <div class="acoes">
          <button (click)="marcarConquistasComoLidas()">Marcar como lido</button>
        </div>
      </div>
    }
  </aside>

  <!-- area principal onde fica as mensagens -->
  <main class="area-conversa">
    <header class="cabecalho-conversa">
        <div class="cabecalho-esquerda">
  <div class="logo-titulo">NEXUS</div>
      </div>

      <div class="cabecalho-direita">
        <div class="perfil" role="region" aria-label="perfil">
          <div class="perfil-info">

          
          </div>
          <!-- botao que abre o bloco com detalhes do usuario -->
          <button class="botao-perfil" (click)="togglePerfil()" aria-expanded="{{showPerfil}}" aria-controls="bloco-perfil">üë§</button>

          <!-- bloco com dados do perfil aparece quando showperfil ta ativo -->
          @if (showPerfil) {
          <div id="bloco-perfil" class="bloco-perfil" role="dialog" aria-modal="false">
            <div class="conteudo-bloco">
              <div class="titulo-bloco">Meu Perfil</div>
                
            </div>
          </div>
          }
        </div>
      </div>
    </header>

  <!-- lista onde as mensagens sao mostradas -->
  <div class="lista-mensagens" #mensagensArea (mouseup)="onMouseUpMensagens($event)">


      <div
        *ngFor="let msg of mensagem; trackBy:
         trackByIndex"
        [ngClass]="msg.sender"
      >
  <!-- se for mensagem do tipo digitando mostra uma animacao -->
        @if (msg.typing) {
          <div class="pontos-badge" title="Seus pontos">
            ‚≠ê <span class="pontos-num">{{ pontos }}</span>
            <div class="barra-xp">

              <div class="preenchimento" [style.width.%]="progressoNivel"></div>
            </div>
            <span class="nivel">Nv {{ nivel }}</span>
          </div>
          <p><strong>NexusBot:</strong> <span class="typing">digitando</span></p>
        } @else {
          @if (msg.tipo === 'balao-acao') {
            <div class="balao-analise">
              <div class="balao-topo">

                <span class="balao-titulo">An√°lise do Texto</span>
              </div>
              <div class="balao-corpo">

                <div class="balao-acoes">
                       <button (click)="resumirTextoAlvo(msg)">Resumir texto</button>
                  <div class="definir-inline">
                    <input [(ngModel)]="msg.palavra" placeholder="Palavra" />
                      <button (click)="definirPalavraBalao(msg)">Definir</button>
                  </div>

                  <span class="dica">Dica: selecione trechos nas mensagens para Resumir ou abrir Defini√ß√£o.</span>

                </div>
                @if (msg.resumo){
                  <div class="balao-bloco">
                      <h4>Resumo</h4>
                    <p>{{msg.resumo}}</p>
                  </div>
                }
                @if (msg.definicao){
                  <div class="balao-bloco">
                      <h4>Defini√ß√£o</h4>

                    <p>{{msg.definicao}}</p>
                    @if (msg.sinonimos?.length){

                      <div class="sinonimos">
                        <span>Sin√¥nimos:</span>

                        <ul>

                            <li *ngFor="let s of msg.sinonimos">{{s}}</li>
                        </ul>
                      </div>
                    }

                  </div>
                }

              </div>
            </div>
          } @else {
             <p><strong>{{ msg.sender === 'usuario' ? 'Voc√™' : 'NexusBot' }}:</strong> {{msg.text}}</p>
          }
        }
      </div>

  <!-- popover de selecao para a conversa -->
      @if (showPopup) {
        <div id="popup-selecao" class="popup-selecao" [style.left.px]="popupX" [style.top.px]="popupY">
          <div class="popup-botoes">
            <button (mousedown)="$event.preventDefault()" (click)="resumirSelecao()">Resumir</button>
            <button (mousedown)="$event.preventDefault()" (click)="definirSelecao()">Defini√ß√£o</button>
            <button class="fechar" (click)="fecharPopup()" aria-label="fechar">‚úñ</button>
          </div>
        </div>
      }

  <!-- balao flutuante com definicao ou resumo -->
      @if (showBalaoAcao) {

        <div class="balao-definicao" [style.left.px]="balaoX" [style.top.px]="balaoY">
          <div class="balao-def-topo">

            <span class="titulo-colorido">{{balaoTitulo}}</span>
            <button class="fechar" (click)="showBalaoAcao=false">‚úñ</button>
          </div>
          <div class="balao-def-corpo">{{balaoConteudo}}</div>
          @if (balaoSinonimos.length) {

            <div class="balao-def-sins">
              <span>Sin√¥nimos:</span>
              <ul>
              
                
                <li *ngFor="let s of balaoSinonimos">{{ s }}</li>

              </ul>
            </div>
          }
        </div>
      }

    </div>

  <!-- area onde digita e envia mensagens -->
  <div class="area-entrada">
      <input
        type="text"
        [(ngModel)]="novaMensagem"
        placeholder="digite uma mensagem"
        (keyup.enter)="mandarMensagem()"
        aria-label="mensagem"

        
      />
        <button class="botao-enviar" (click)="mandarMensagem()" aria-label="enviar">‚úâÔ∏è</button>
    </div>

  </main>



</div>
